# H-BAT Web アプリ開発タスク一覧

**プロジェクト**: Harvard Beat Assessment Test (H-BAT) Web Application  
**期間**: 14日間  
**更新日**: 2024年12月  
**変更**: BST生成パート削除による簡略化

---

## 📋 プロジェクト概要

| 項目 | 内容 |
|------|------|
| **テスト内容** | 聴力閾値テスト + BST知覚テスト |
| **総テスト時間** | 約10分（従来13分から短縮） |
| **画面数** | 5画面（生成パート削除により1画面減） |
| **技術スタック** | Next.js 14, TypeScript, Supabase, Tone.js |

---

## 📅 開発スケジュール

### **Phase 1: 基盤構築 (Day 1-3)** ✅ 完了

#### **Day 1 - プロジェクト初期化**
- [x] GitHubリポジトリ作成・連携
- [x] Next.js 14プロジェクト作成
- [x] TypeScript + Tailwind CSS設定
- [x] 依存関係インストール
- [x] GitHub Actions CI/CD設定
- [x] Vitest + Playwright テスト環境構築

#### **Day 2 - データベース設計**
- [x] Supabaseプロジェクト作成
- [x] データベーススキーマ設計（BST知覚のみ）
- [x] マイグレーションファイル作成
- [x] RLS（Row Level Security）ポリシー設定
- [x] TypeScript型定義作成

#### **Day 3 - 基本設定**
- [x] 環境変数設定
- [x] Supabaseクライアント設定
- [x] プロジェクト構造の確立
- [x] 設計仕様書更新（生成パート削除）

---

### **Phase 2: 聴力閾値テスト実装 (Day 4-7)**

#### **Day 4 - 音声エンジン基盤**
- [ ] **Web Audio API設定**
  - [ ] AudioContextの初期化とエラーハンドリング
  - [ ] サンプルレート48kHz固定設定
  - [ ] ブラウザ互換性チェック（Chrome, Safari, Firefox, Edge）
- [ ] **純音生成エンジン**
  - [ ] 1000Hz, 2000Hz, 4000Hz発振器実装
  - [ ] dB HL → リニアゲイン変換関数
  - [ ] 音声再生タイミング制御

**チェックポイント**: 各周波数の純音が正確に再生できること

#### **Day 5 - ステアケース法実装**
- [ ] **アルゴリズム実装**
  - [ ] 2-down/1-up ルール実装
  - [ ] ステップサイズ制御（5dB → 2.5dB）
  - [ ] 反転点検出ロジック
  - [ ] 閾値計算（6回反転点の平均）
- [ ] **状態管理**
  - [ ] テスト進行状況管理
  - [ ] 試行履歴記録
  - [ ] エラー状態処理

**チェックポイント**: ステアケース法が正しく動作すること

#### **Day 6 - UI実装**
- [ ] **聴力閾値テスト画面**
  - [ ] 周波数切り替えタブ UI
  - [ ] 「聞こえた」「聞こえない」ボタン
  - [ ] 進行状況インジケーター
  - [ ] 音量レベル表示（デバッグ用）
- [ ] **レスポンシブデザイン**
  - [ ] デスクトップ対応
  - [ ] モバイル・タブレット対応
  - [ ] アクセシビリティ対応

**チェックポイント**: UIが直感的で使いやすいこと

#### **Day 7 - データ保存・バリデーション**
- [ ] **API実装**
  - [ ] テスト開始エンドポイント
  - [ ] 結果保存エンドポイント
  - [ ] データバリデーション
- [ ] **エラーハンドリング**
  - [ ] ネットワークエラー対応
  - [ ] 途中離脱時の状態保存
  - [ ] リトライ機能

**チェックポイント**: データが正確に保存されること

---

### **Phase 3: BST知覚テスト実装 (Day 8-10)**

#### **Day 8 - 音響刺激生成**
- [ ] **BSTプレイヤー実装**
  - [ ] 120 BPM クリック音生成
  - [ ] 強拍・弱拍の振幅制御
  - [ ] 2拍子・3拍子パターン生成
  - [ ] Hanning窓50ms クリック実装
- [ ] **振幅制御**
  - [ ] ΔdB → リニアゲイン変換
  - [ ] 聴力閾値+30dB基準設定
  - [ ] 音量差のリアルタイム調整

**チェックポイント**: 2拍子・3拍子が明確に区別できること

#### **Day 9 - BST知覚ステアケース**
- [ ] **BST専用ステアケース**
  - [ ] 正答2回で半減ルール実装
  - [ ] 誤答1回で倍増ルール実装
  - [ ] 初期ΔdB=20dB設定
  - [ ] 6回反転で終了
- [ ] **UI実装**
  - [ ] 音響刺激再生ボタン
  - [ ] 「2拍子」「3拍子」選択ボタン
  - [ ] 進行状況表示
  - [ ] パターンランダム化

**チェックポイント**: ステアケースが適切に収束すること

#### **Day 10 - BST統合・テスト**
- [ ] **統合テスト**
  - [ ] 聴力閾値からBSTへの流れ
  - [ ] データ整合性チェック
  - [ ] パフォーマンス最適化
- [ ] **単体テスト**
  - [ ] 音響アルゴリズムテスト
  - [ ] ステアケース法テスト
  - [ ] データ保存テスト

**チェックポイント**: 全テストフローが正常動作すること

---

### **Phase 4: UI/UX・結果画面 (Day 11-12)**

#### **Day 11 - 基本画面実装**
- [ ] **トップページ**
  - [ ] 研究概要・説明文
  - [ ] 利用規約・同意書
  - [ ] 診断開始ボタン
  - [ ] レスポンシブレイアウト
- [ ] **基本情報入力画面**
  - [ ] 年齢入力（必須、10-100歳バリデーション）
  - [ ] 性別選択（任意）
  - [ ] React Hook Form + Zod バリデーション
  - [ ] Supabase profiles テーブル連携

**チェックポイント**: フォームバリデーションが正常動作すること

#### **Day 12 - 結果表示画面**
- [ ] **結果可視化**
  - [ ] 聴力閾値グラフ（Chart.js）
  - [ ] BST知覚閾値表示
  - [ ] 横軸：周波数、縦軸：閾値dB
  - [ ] インタラクティブグラフ
- [ ] **UI改善**
  - [ ] 結果の解釈説明
  - [ ] 再試行リンク
  - [ ] PDF出力機能（オプション）

**チェックポイント**: 結果が分かりやすく表示されること

---

### **Phase 5: 管理画面・最終調整 (Day 13-14)**

#### **Day 13 - 管理ダッシュボード**
- [ ] **管理画面実装**
  - [ ] 管理者認証（Supabase Auth）
  - [ ] 参加者数・統計表示
  - [ ] 日時別データ推移グラフ
  - [ ] 平均閾値のヒートマップ
- [ ] **データエクスポート**
  - [ ] CSV出力機能（Papaparse）
  - [ ] 期間フィルタ機能
  - [ ] 匿名化データ出力

**チェックポイント**: 管理者が効率的にデータを確認できること

#### **Day 14 - E2Eテスト・デプロイ**
- [ ] **E2Eテスト（Playwright）**
  - [ ] 全画面遷移テスト
  - [ ] 異なるブラウザでのテスト
  - [ ] モバイルデバイステスト
  - [ ] パフォーマンステスト
- [ ] **最終調整**
  - [ ] SFC研究倫理審査委員会承認番号の追加
  - [ ] プライバシーポリシー・利用規約の最終確認
  - [ ] Vercel本番環境デプロイ

**チェックポイント**: 全機能が本番環境で正常動作すること

---

## 🧪 テスト要件

### **単体テスト (Vitest)**
- [ ] 音響ユーティリティ関数
- [ ] ステアケース法アルゴリズム
- [ ] データバリデーション
- [ ] API エンドポイント

### **E2Eテスト (Playwright)**
- [ ] 全画面フロー
- [ ] マルチブラウザ対応
- [ ] モバイル端末対応
- [ ] パフォーマンス要件

### **手動テスト**
- [ ] 音響品質確認
- [ ] 実際のテスト実施体験
- [ ] 管理画面機能確認

---

## 📊 成果物チェックリスト

### **コードベース**
- [ ] 全TypeScriptファイル型エラーなし
- [ ] ESLintエラーなし
- [ ] 単体テストカバレッジ80%以上
- [ ] E2Eテスト全て通過

### **ドキュメント**
- [ ] README.md更新
- [ ] API仕様書
- [ ] デプロイ手順書
- [ ] 使用方法マニュアル

### **デプロイメント**
- [ ] Vercel本番環境
- [ ] Supabase本番データベース
- [ ] 環境変数設定完了
- [ ] ドメイン設定（オプション）

---

## ⚠️ リスク管理

| リスク | 影響度 | 対策 |
|--------|--------|------|
| **Web Audio API ブラウザ互換性** | 高 | フォールバック実装・事前テスト |
| **音響精度の問題** | 中 | 専門家レビュー・較正 |
| **Supabase接続エラー** | 中 | エラーハンドリング・リトライ |
| **モバイル対応不備** | 低 | レスポンシブテスト強化 |

---

## 🎯 品質基準

| 項目 | 基準 | 測定方法 |
|------|------|----------|
| **音響精度** | ±1Hz, ±20ms以内 | 専用測定ツール |
| **レスポンス時間** | 100ms以内 | Lighthouse測定 |
| **テストカバレッジ** | 80%以上 | Vitest coverage |
| **アクセシビリティ** | WCAG 2.1 AA | axe-core |

---

## 📝 進捗管理

- **Daily**: 各タスクの進捗確認
- **Phase終了時**: チェックポイント確認・次Phase準備
- **最終**: 全成果物レビュー・デプロイ

**GitHub Issues/Projects で進捗管理を行い、各タスクの完了状況を追跡します。** 